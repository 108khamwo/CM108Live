<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="CM108 Live">
    
    <title>CM108 Mobile Unit</title>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #007aff;
            --success: #34c759;
            --danger: #ff3b30;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100dvh; background: #000; font-family: 'Prompt', sans-serif; overflow: hidden; }

        /* --- LOBBY SECTION --- */
        #lobby { 
            position: absolute; inset: 0; z-index: 100; background: #111; 
            display: flex; flex-direction: column; padding: 20px; text-align: center; overflow-y: auto; 
        }
        h1 { color: var(--primary); margin-bottom: 10px; font-size: 26px; font-weight: 700; }
        .label { color: #888; font-size: 14px; margin: 15px 0 10px; border-bottom: 1px solid #333; padding-bottom: 5px; text-align: left; }
        
        .mode-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
        .m-btn { 
            background: #1a1a1a; border: 1px solid #333; border-radius: 12px; padding: 15px 5px; 
            color: #888; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 5px; 
        }
        .m-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        .m-btn span { font-weight: bold; font-size: 14px; }
        .m-btn small { font-size: 10px; opacity: 0.8; }
        
        .cam-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
        .c-card { 
            background: linear-gradient(145deg, #222, #1b1b1b); border: 1px solid #333; 
            border-radius: 12px; padding: 25px 0; cursor: pointer; color: white; transition: 0.2s;
        }
        .c-card:active { transform: scale(0.98); border-color: var(--primary); }
        .c-card strong { display: block; font-size: 18px; margin-bottom: 5px; }

        /* --- LIVE VIEW --- */
        #live-view { display: none; position: fixed; inset: 0; background: #000; z-index: 50; }
        iframe { width: 100%; height: 100%; border: none; }

        /* --- UI OVERLAYS --- */
        .status-bar {
            position: fixed !important; top: 15px; left: 15px; z-index: 2000;
            background: rgba(0,0,0,0.6); padding: 8px 15px; border-radius: 20px;
            color: white; font-size: 11px; display: flex; gap: 12px; align-items: center;
            backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1);
            pointer-events: auto; cursor: pointer;
        }

        .side-ctrl {
            position: fixed !important; right: 15px; top: 50%; transform: translateY(-50%);
            display: flex; flex-direction: column; gap: 15px; align-items: center;
            background: rgba(0,0,0,0.6); padding: 15px 10px; border-radius: 35px;
            backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1);
            z-index: 2000; pointer-events: auto;
        }
        .btn-act { 
            width: 48px; height: 48px; border-radius: 50%; border: none; 
            background: rgba(255,255,255,0.15); color: white; font-size: 22px; 
            cursor: pointer; display: flex; align-items: center; justify-content: center; 
        }
        .btn-act:active { background: white; color: black; }
        .btn-home { background: var(--primary); font-size: 11px; font-weight: bold; }

        /* --- MESSAGE TOAST (Popup) --- */
        #msg-toast {
            position: fixed !important; top: 20%; left: 50%; transform: translate(-50%, -50%);
            width: 85%; max-width: 400px; background: rgba(0,0,0,0.95); 
            border-left: 8px solid var(--success); 
            color: white; padding: 25px; border-radius: 15px; text-align: center;
            display: none; z-index: 9999999 !important; pointer-events: auto;
            box-shadow: 0 20px 50px rgba(0,0,0,0.9);
            animation: slideInToast 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28);
            backdrop-filter: blur(15px);
        }
        @keyframes slideInToast { 
            from { opacity: 0; transform: translate(-50%, -100%); } 
            to { opacity: 1; transform: translate(-50%, -50%); } 
        }
        .toast-close { position: absolute; top: 10px; right: 15px; color: #555; font-size: 24px; background: none; border: none; cursor: pointer; }

        /* --- CHAT REPLY PANEL --- */
        #chat-panel {
            position: fixed !important; bottom: 25px; left: 50%; transform: translateX(-50%);
            width: 92%; max-width: 420px; background: rgba(15,15,15,0.96);
            border: 1px solid rgba(255,255,255,0.1); border-top: 4px solid var(--primary);
            padding: 20px; border-radius: 18px; z-index: 900000 !important;
            display: none; flex-direction: column; gap: 12px;
            backdrop-filter: blur(25px); pointer-events: auto;
        }
        .chat-panel-close { position: absolute; top: 10px; right: 15px; color: #555; background: none; border: none; font-size: 24px; cursor: pointer; }
        .quick-replies { display: flex; gap: 8px; }
        .quick-replies button {
            flex: 1; background: #222; color: white; border: 1px solid #333;
            padding: 14px 5px; border-radius: 12px; font-size: 13px; cursor: pointer; font-family: 'Prompt', sans-serif;
        }
        .quick-replies button:active { background: var(--primary); }
        .chat-input-row { display: flex; gap: 10px; }
        #chat-input {
            flex: 1; background: #000; border: 1px solid #444; color: white;
            padding: 14px; border-radius: 12px; font-family: 'Prompt', sans-serif; font-size: 16px; outline: none;
        }
        .btn-send { background: var(--primary); color: white; border: none; padding: 0 22px; border-radius: 12px; font-weight: bold; cursor: pointer; }

        /* --- HISTORY PANEL (‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏™‡∏µ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô) --- */
        #history-panel {
            position: fixed !important; inset: 0; background: rgba(5,5,5,0.98);
            z-index: 950000 !important; display: none; flex-direction: column;
            padding-top: env(safe-area-inset-top, 25px);
            backdrop-filter: blur(30px);
        }
        .history-top { padding: 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #222; }
        #history-list { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 12px; }
        
        .h-item { 
            padding: 14px 18px; 
            border-radius: 16px; 
            max-width: 85%; 
            line-height: 1.5; 
            font-size: 15px; /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏ô‡∏≤‡∏î‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡πÉ‡∏´‡πâ‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢ */
            color: #ffffff; /* ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß 100% */
            word-break: break-word; /* ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏ó‡∏∞‡∏•‡∏∏‡∏Å‡∏£‡∏≠‡∏ö */
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏á‡∏≤‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á */
        }
        .h-meta { 
            font-size: 11px; 
            margin-bottom: 6px; 
            color: #bbbbbb; /* ‡∏™‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ‡∏≠‡πà‡∏≠‡∏ô‡∏•‡∏á‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏≠‡πà‡∏≤‡∏ô‡∏¢‡∏≤‡∏Å */
        }
        .h-from-mcr { 
            align-self: flex-start; 
            background: #222222; /* ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏ó‡∏≤‡πÄ‡∏Ç‡πâ‡∏°‡∏ï‡∏±‡∏î‡∏Å‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß */
            border-left: 4px solid var(--success); 
        }
        .h-from-me { 
            align-self: flex-end; 
            background: #003b73; /* ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏° ‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß‡πÄ‡∏î‡πà‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤‡∏Å */
            border-right: 4px solid var(--primary); 
            text-align: right; 
        }

        /* --- GHOST MODE --- */
        #ghost { position: fixed !important; inset: 0; background: #000; z-index: 99999999 !important; display: none; align-items: center; justify-content: center; flex-direction: column; color: #444; }
    </style>
</head>
<body>

    <div id="lobby">
        <h1>CM108 LIVE</h1>
        <div class="label">1. ‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì</div>
        <div class="mode-grid">
            <div class="m-btn active" id="m-hq" onclick="setMode('hq')"><span>‡∏ä‡∏±‡∏î‡∏û‡∏¥‡πÄ‡∏®‡∏©</span><small>1080p 60fps</small></div>
            <div class="m-btn" id="m-safe" onclick="setMode('safe')"><span>‡πÄ‡∏ô‡πâ‡∏ô‡πÄ‡∏™‡∏ñ‡∏µ‡∏¢‡∏£</span><small>720p 30fps</small></div>
            <div class="m-btn" id="m-auto" onclick="setMode('auto')"><span>‡∏≠‡∏≠‡πÇ‡∏ï‡πâ</span><small>‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡πÄ‡∏ô‡πá‡∏ï</small></div>
        </div>
        <div class="label">2. ‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á</div>
        <div class="cam-grid">
            <div class="c-card" onclick="start('CM108_Cam1')"><strong>CAM 01</strong><small>‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏Å</small></div>
            <div class="c-card" onclick="start('CM108_Cam2')"><strong>CAM 02</strong><small>‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏£‡∏≠‡∏á</small></div>
            <div class="c-card" onclick="start('CM108_Cam3')"><strong>CAM 03</strong><small>‡∏°‡∏∏‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á</small></div>
        </div>
    </div>

    <div id="live-view">
        <iframe id="vid" allow="camera;microphone;fullscreen;display-capture;autoplay"></iframe>

        <div class="status-bar" id="status-bar" style="display: none;" onclick="testToast()">
            <div class="status-item"><span id="net-icon">üü¢</span> <span id="net-text">Signal OK</span></div>
        </div>

        <div class="side-ctrl">
            <button class="btn-act" onclick="toggleChat()">üí¨</button>
            <button class="btn-act" onclick="toggleHistory()">üìú</button>
            <button class="btn-act" onclick="toggleFullScreen()">‚õ∂</button>
            <button class="btn-act" onclick="toggleGhost()">üåô</button>
            <button class="btn-act btn-home" onclick="location.reload()">HOME</button>
        </div>
    </div>

    <div id="msg-toast">
        <button class="toast-close" onclick="closeToast()">‚úï</button>
        <div style="font-size:11px; color:var(--success); margin-bottom:10px; font-weight: bold; text-transform: uppercase; letter-spacing: 1px;">üì• ‡∏®‡∏π‡∏ô‡∏¢‡πå MCR ‡πÅ‡∏à‡πâ‡∏á‡∏ß‡πà‡∏≤:</div>
        <span id="msg-text" style="font-size:26px; font-weight:700; color:#fff; line-height: 1.3;">--</span>
    </div>

    <div id="chat-panel">
        <button class="chat-panel-close" onclick="toggleChat()">‚úï</button>
        <div style="font-size:16px; font-weight:bold; color:#fff; margin-bottom:15px;">‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°</div>
        <div class="quick-replies">
            <button onclick="sendQuickChat('‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö')">‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö</button>
            <button onclick="sendQuickChat('‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà')">‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà</button>
            <button onclick="sendQuickChat('‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß')">‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß</button>
        </div>
        <div class="chat-input-row">
            <input type="text" id="chat-input" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°..." onkeypress="if(event.key === 'Enter') sendCustomChat()">
            <button class="btn-send" onclick="sendCustomChat()">‡∏™‡πà‡∏á</button>
        </div>
    </div>

    <div id="history-panel">
        <div class="history-top">
            <h2 style="margin:0; font-size:20px; color:var(--primary);">üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤</h2>
            <button onclick="toggleHistory()" style="background:none; border:none; color:#555; font-size:26px;">‚úï</button>
        </div>
        <div id="history-list"></div>
    </div>

    <div id="ghost" onclick="toggleGhost()">
        <div style="font-size:60px; margin-bottom:20px;">üé•</div>
        <h2 style="color:#fff; margin:0; font-size: 24px;">‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏±‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠</h2>
        <p style="font-size:14px; margin-top:10px; opacity: 0.5;">(‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏ï‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥)</p>
    </div>

    <script>
        let mode = 'hq';
        let currentCam = "";

        function stripHTML(html) {
            if (!html) return "";
            if (typeof html !== 'string') html = String(html);
            return html.replace(/<[^>]*>?/gm, '').replace(/:\s*$/, '').trim();
        }

        function isSystemTrash(str) {
            if (!str) return true;
            const s = String(str).trim();
            if (/[\u0E00-\u0E7F]/.test(s)) return false; 
            if (/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(s)) return true; 
            if (/^-?\d+\.\d+$/.test(s)) return true; 
            if (s === "[object Object]") return true;
            return false;
        }

        function setMode(m) {
            mode = m;
            document.querySelectorAll('.m-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('m-' + m).classList.add('active');
        }

        function start(id) {
            currentCam = id;
            let p = "";
            if(mode === 'hq') p = "&width=1920&height=1080&videobitrate=8000&framerate=60";
            else if(mode === 'safe') p = "&width=1280&height=720&bitrate=2500&framerate=30";
            else p = "&quality=1";

            let url = "https://vdo.ninja/?push=" + id + "&room=CM108_NewsRoom" + p + 
                      "&clean=1&viewchat=1&api=1&label=" + id;

            document.getElementById('vid').src = url;
            document.getElementById('lobby').style.display = 'none';
            document.getElementById('live-view').style.display = 'block';
            document.getElementById('status-bar').style.display = 'flex';
            
            requestWakeLock();
            
            window.addEventListener('message', function(e) {
                if (!e.data) return;
                let data = e.data;
                
                if (typeof data === 'string' && data.trim().startsWith('{')) {
                    try { data = JSON.parse(data); } catch(err) { return; }
                }

                const action = (data.action || data.type || "").toLowerCase();
                const ignoreActions = ['stats', 'mic_volume', 'video_bitrate', 'variable', 'room_info', 'stream_update'];
                if (ignoreActions.includes(action)) return;

                let fMsg = null;

                function findChat(obj) {
                    if (!obj || typeof obj !== 'object') return false;
                    let p = null;
                    if (obj.gotchat && obj.gotchat.msg) p = obj.gotchat.msg;
                    else if (obj.msg && typeof obj.msg === 'string') p = obj.msg;
                    else if (obj.chat && typeof obj.chat === 'string') p = obj.chat;
                    else if (obj.text && typeof obj.text === 'string') p = obj.text;
                    else if (typeof obj.msg === 'number') p = String(obj.msg);
                    else if (typeof obj.chat === 'number') p = String(obj.chat);

                    if (p !== null) {
                        fMsg = String(p);
                        return true;
                    }
                    for (let k in obj) {
                        if (obj[k] && typeof obj[k] === 'object' && k !== 'data') {
                            if (findChat(obj[k])) return true;
                        }
                    }
                    if (obj.data && typeof obj.data === 'object') {
                        if (findChat(obj.data)) return true;
                    }
                    return false;
                }

                findChat(data);

                if (fMsg) {
                    let cleanMsg = stripHTML(fMsg);
                    if (cleanMsg !== "" && !isSystemTrash(cleanMsg)) {
                        showToast(cleanMsg);
                        addHistory(cleanMsg, "‡∏®‡∏π‡∏ô‡∏¢‡πå MCR", false);
                    }
                }
            });
        }

        function sendToNinjaChat(text) {
            const iframe = document.getElementById('vid');
            if (!iframe || !iframe.contentWindow) return;
            iframe.contentWindow.postMessage({ "action": "sendChat", "value": text }, '*');
            iframe.contentWindow.postMessage({ "sendChat": text }, '*');
            addHistory(text, "‡πÄ‡∏£‡∏≤ (‡∏™‡∏ô‡∏≤‡∏°)", true);
            if (document.getElementById('chat-panel').style.display === 'flex') toggleChat();
        }

        function sendQuickChat(text) { sendToNinjaChat(text); }
        function sendCustomChat() {
            let input = document.getElementById('chat-input');
            if (input.value.trim()) {
                sendToNinjaChat(input.value.trim());
                input.value = '';
            }
        }

        function addHistory(msg, sender, isMe) {
            const list = document.getElementById('history-list');
            const time = new Date().toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
            
            if (list.innerText.includes("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥")) list.innerHTML = "";
            
            const div = document.createElement('div');
            div.className = `h-item ${isMe ? 'h-from-me' : 'h-from-mcr'}`;
            div.innerHTML = `<div class="h-meta">${sender} ‚Ä¢ ${time}</div><div class="h-msg">${msg}</div>`;
            list.appendChild(div);
            list.scrollTop = list.scrollHeight;
        }

        function toggleChat() {
            document.getElementById('history-panel').style.display = 'none';
            let p = document.getElementById('chat-panel');
            p.style.display = (p.style.display === 'flex') ? 'none' : 'flex';
            if(p.style.display === 'flex') document.getElementById('chat-input').focus();
        }

        function toggleHistory() {
            document.getElementById('chat-panel').style.display = 'none';
            let p = document.getElementById('history-panel');
            p.style.display = (p.style.display === 'flex') ? 'none' : 'flex';
        }

        let toastT;
        function showToast(txt) {
            const t = document.getElementById('msg-toast');
            const m = document.getElementById('msg-text');
            m.innerText = txt;
            
            t.style.display = 'none';
            void t.offsetWidth;
            t.style.display = 'block';
            
            if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
            
            if(toastT) clearTimeout(toastT);
            toastT = setTimeout(() => { t.style.display = 'none'; }, 12000);
        }

        function testToast() {
            showToast("‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏õ‡πâ‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏® OK!");
        }

        function closeToast() { document.getElementById('msg-toast').style.display = 'none'; }
        function toggleGhost() { document.getElementById('ghost').style.display = (document.getElementById('ghost').style.display === 'flex') ? 'none' : 'flex'; }
        function toggleFullScreen() {
            const el = document.documentElement;
            if (!document.fullscreenElement && !document.webkitFullscreenElement) {
                (el.requestFullscreen || el.webkitRequestFullscreen).call(el);
            } else {
                (document.exitFullscreen || document.webkitExitFullscreen).call(document);
            }
        }
        async function requestWakeLock() { try { if ('wakeLock' in navigator) await navigator.wakeLock.request('screen'); } catch (e) {} }
    </script>
</body>
</html>
